
## 1. 系统概述

### 1.1 项目背景与目标

开发一套基于QT和OpenCV的人脸识别排座系统，满足学校考勤管理需求，通过人脸识别技术实现自动考勤，通过统一登录界面区分不同角色权限。

### 1.2 系统架构

- 采用C/S架构(客户端/服务器)
- 三端应用：考勤端、统一客户端(老师/学生/管理员)、服务器端
- 基于TCP/IP协议和RESTful API通信

## 2. 技术栈选择

### 2.1 开发环境

- 操作系统：Windows 11
- 开发工具：Qt Creator 16.0
- 编译器：Desktop Qt 5.15.2 MinGW 64-bit


### 2.2 核心技术

- UI框架：Qt 5.15.2
- 人脸识别：OpenCV 4.6.0
- 数据库：SQLite
- 网络通信：Qt Network模块
- 数据序列化：JSON

## 3. 系统模块设计

### 3.1 考勤端

#### 3.1.1 界面分区

- **登录界面**：用户名/密码输入框、登录按钮
- **考勤列表界面**：显示考场考勤名单
- **考勤界面**：实时摄像头画面与识别结果

#### 3.1.2 核心类设计

- **人脸检测器类(FaceDetector)**：负责从图像中检测人脸
- **人脸识别器类(FaceRecognizer)**：加载人脸数据并进行识别
- **摄像头管理类(CameraManager)**：管理摄像头捕获和视频流
- **考勤管理类(AttendanceManager)**：处理考勤记录和数据上传

#### 3.1.3 考勤流程

1. 操作员登录考勤端
2. 选择当前考场，加载学生名单
3. 启动摄像头，开始人脸识别
4. 识别到学生后，自动标记考勤状态
5. 实时上传考勤结果到服务器

### 3.2 统一客户端

#### 3.2.1 登录模块

- **统一登录对话框(LoginDialog)**：处理所有角色的登录验证
- 根据登录成功后返回的角色信息，动态加载不同界面

#### 3.2.2 主应用框架

- **主应用窗口(MainWindow)**：包含堆叠小部件管理多个界面
- 根据登录角色加载对应界面(教师/学生/管理员)
- 处理注销和界面切换

#### 3.2.3 教师模块

- **教师界面(TeacherWidget)**：显示教师相关功能
- **班级管理标签页(ClassManagementTab)**：管理班级和学生
- **考场管理标签页(ExamRoomTab)**：管理考场和查看考勤

#### 3.2.4 学生模块

- **学生界面(StudentWidget)**：显示学生个人信息和考勤记录
- 查看个人考勤历史和班级信息

#### 3.2.5 管理员模块

- **管理员界面(AdminWidget)**：系统管理功能
- **用户管理标签页(UserManagementTab)**：管理所有用户
- **数据库管理标签页(DatabaseManagementTab)**：备份和恢复数据库

### 3.3 服务器端

#### 3.3.1 服务器架构

- **服务器应用(ServerApplication)**：处理客户端连接和请求
- **请求处理器(RequestHandler)**：解析并处理不同类型的请求
- **数据库管理器(DatabaseManager)**：处理数据库操作
- **认证管理器(AuthManager)**：管理用户认证和令牌

## 4. 数据库设计

### 4.1 ER图

### 4.2 表结构设计

#### 4.2.1 用户表(Users)

存储所有用户的基本信息和认证数据，包括用户名、密码哈希、角色等。

#### 4.2.2 学生表(Students)

存储学生特有信息，包括学号、班级ID和人脸特征数据，关联到用户表。

#### 4.2.3 教师表(Teachers)

存储教师特有信息，包括部门和职称，关联到用户表。

#### 4.2.4 班级表(Classes)

存储班级信息，包括班级名称、负责教师、年级等。

#### 4.2.5 班级学生关联表(ClassStudents)

多对多关系表，关联班级和学生。

#### 4.2.6 考场表(ExamRooms)

存储考场信息，包括考场名称、位置、容量、考试日期和时间。

#### 4.2.7 考场座位表(ExamSeats)

存储考场座位分配信息，关联考场和学生。

#### 4.2.8 考勤记录表(AttendanceRecords)

存储考勤记录，包括学生ID、考场ID、考勤时间和状态。

#### 4.2.9 系统日志表(SystemLogs)

记录系统操作日志，包括用户操作、时间和详情。

## 5. 通信协议设计

### 5.1 通用消息格式

JSON格式，包含请求ID、命令名称、数据和认证令牌。

### 5.2 响应格式

JSON格式，包含请求ID、状态、消息和响应数据。

### 5.3 API端点设计

#### 5.3.1 认证API

- `auth/login` - 用户登录
- `auth/logout` - 用户注销
- `auth/verify` - 验证令牌

#### 5.3.2 学生API

- `student/info` - 获取学生信息
- `student/attendance` - 获取学生考勤记录
- `student/classes` - 获取学生班级

#### 5.3.3 教师API

- `teacher/classes` - 获取教师班级
- `teacher/students` - 获取班级学生
- `teacher/examrooms` - 获取考场信息
- `teacher/attendance` - 获取考勤信息
- `teacher/export` - 导出考勤数据

#### 5.3.4 管理员API

- `admin/users` - 用户管理
- `admin/classes` - 班级管理
- `admin/examrooms` - 考场管理
- `admin/database` - 数据库管理

#### 5.3.5 考勤API

- `attendance/students` - 获取考场学生
- `attendance/record` - 记录考勤
- `attendance/update` - 更新考勤状态

## 6. 人脸识别算法设计

### 6.1 人脸检测

使用OpenCV的Haar级联分类器检测人脸，处理步骤包括：

- 将摄像头帧转换为灰度图
- 应用人脸检测算法
- 处理检测到的人脸区域

### 6.2 人脸识别

使用LBPH(局部二值模式直方图)算法识别人脸：

- 创建并训练人脸识别器
- 预处理人脸图像(调整大小、直方图均衡化)
- 基于训练模型识别人脸，返回标签和置信度

### 6.3 特征提取与匹配

可选择使用深度学习方法提高识别准确率：

- 使用预训练的深度学习模型提取人脸特征
- 计算特征向量之间的相似度
- 基于相似度阈值判断身份

## 7. 安全设计

### 7.1 用户认证安全

- 使用加盐哈希保存密码
- 生成安全的随机盐值
- 使用JWT令牌进行API认证

### 7.2 数据传输安全

- 配置SSL/TLS加密通信
- 加密敏感数据
- 实现安全的会话管理

### 7.3 权限控制

- 基于角色的权限控制矩阵
- 严格校验每个请求的权限
- 隔离不同角色的功能

## 8. 数据流设计

### 8.1 登录流程

1. 客户端发送登录请求(用户名/密码)
2. 服务器验证用户身份
3. 服务器生成JWT令牌并返回
4. 客户端保存令牌，加载相应界面

### 8.2 考勤流程

1. 考勤端登录并选择考场
2. 服务器发送考场学生名单
3. 考勤端启动摄像头识别
4. 识别到学生后记录考勤
5. 发送考勤记录到服务器
6. 服务器更新数据库

### 8.3 数据查询流程

1. 客户端发送带令牌的查询请求
2. 服务器验证令牌有效性
3. 服务器验证用户权限
4. 服务器查询数据库并返回结果
5. 客户端显示结果

## 9. 异常处理

### 9.1 网络异常

处理各种网络错误，包括连接拒绝、主机未找到、超时等情况，实现重试机制。

### 9.2 识别失败处理

处理人脸识别可能的失败情况，包括未检测到人脸、低置信度、多个人脸等。

### 9.3 数据库异常

处理数据库操作过程中可能出现的错误，包括连接错误、SQL语句错误、事务错误等。