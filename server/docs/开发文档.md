# 人脸识别排座系统 - 开发文档

## 1. 系统架构

人脸识别排座系统采用客户端-服务器（C/S）架构，主要包含以下组件：

### 1.1 整体架构

```
+----------------+      HTTP/JSON      +------------------+
|                |<------------------->|                  |
|   考勤端 (Qt)   |                     |  服务器 (Node.js) |
|                |                     |                  |
+----------------+                     +------------------+
        |                                      |
        v                                      v
+----------------+                     +------------------+
|                |                     |                  |
| OpenCV人脸识别  |                     |   数据存储层      |
|                |                     |                  |
+----------------+                     +------------------+
```

### 1.2 技术栈

- **考勤端**：
  - Qt 5.15.2：UI框架
  - C++：核心语言
  - OpenCV 4.6.0：图像处理和人脸识别
  - SQLite：本地数据存储

- **服务器端**：
  - Node.js：服务器运行环境
  - Express：Web框架
  - JWT：用户认证
  - JSON：数据交换格式

## 2. 考勤端组件详解

### 2.1 核心类

#### 2.1.1 MainWindow

主窗口类，负责UI显示和用户交互，包含以下主要功能：
- 摄像头视频流处理
- 人脸注册与识别
- 考勤管理

```cpp
class MainWindow : public QMainWindow
{
    Q_OBJECT
    
public:
    MainWindow(QWidget *parent = nullptr);
    ~MainWindow();
    
private slots:
    // 各种槽函数定义
    
private:
    // 成员变量和辅助方法
};
```

#### 2.1.2 NetworkManager

网络管理类，负责与服务器通信，采用单例模式：

```cpp
class NetworkManager : public QObject
{
    Q_OBJECT
    
public:
    static NetworkManager& getInstance();
    
    bool login(const QString &username, const QString &password);
    QVector<ExamRoom> getExamRooms();
    QVector<StudentInfo> getStudentsForExam(int examRoomId);
    bool uploadAttendanceRecord(int studentId, int examRoomId, const QDateTime &time);
    
signals:
    void networkError(const QString &errorMessage);
    
private:
    // 私有构造函数和成员变量
};
```

#### 2.1.3 LoginDialog

登录对话框类，处理用户登录：

```cpp
class LoginDialog : public QDialog
{
    Q_OBJECT
    
public:
    LoginDialog(QWidget *parent = nullptr);
    ~LoginDialog();
    
    QString getUsername() const;
    QString getServerUrl() const;
    
private slots:
    void onLoginButtonClicked();
    
private:
    // 成员变量和辅助方法
};
```

### 2.2 人脸识别流程

1. **人脸检测**：使用Haar级联分类器检测图像中的人脸区域
2. **人脸预处理**：裁剪、调整大小、直方图均衡化
3. **特征提取**：使用LBPH算法提取人脸特征
4. **人脸识别**：将提取的特征与数据库中的特征比对，返回最匹配的结果和置信度

关键代码：

```cpp
// 创建人脸识别器
model = cv::face::LBPHFaceRecognizer::create();

// 训练模型
model->train(faces, labels);

// 识别人脸
int label = -1;
double confidence = 0.0;
model->predict(faceROI, label, confidence);
```

### 2.3 数据存储

本地使用SQLite数据库存储：
- users表：存储用户信息
- attendance表：存储本地考勤记录

人脸数据存储：
- 人脸图像：存储在`/data/faces/[label]/face_[index].jpg`
- 人脸对应信息：存储在`/data/names.txt`
- 训练模型：存储在`/data/faces.xml`

## 3. 服务器端详解

### 3.1 服务器架构

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  API控制器      |---->|   业务逻辑层    |---->|    数据模型     |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
        ^                                            |
        |                                            v
+----------------+                           +----------------+
|                |                           |                |
|  认证中间件     |                           |    内存存储     |
|                |                           |                |
+----------------+                           +----------------+
```

### 3.2 API路由

```javascript
// 登录接口
app.post('/auth/login', loginController);

// 考场信息接口
app.get('/teacher/examrooms', authenticateToken, getExamRoomsController);

// 学生名单接口
app.post('/attendance/students', authenticateToken, getStudentsController);

// 考勤记录接口
app.post('/attendance/record', authenticateToken, recordAttendanceController);
app.get('/attendance/records', authenticateToken, getAttendanceRecordsController);
```

### 3.3 数据模型

当前版本使用内存数据存储，主要包括：
- users：用户信息
- examRooms：考场信息
- studentsMap：学生信息 (Map结构，考场ID为键)
- attendanceRecords：考勤记录

### 3.4 认证机制

使用JWT (JSON Web Token) 进行用户认证，流程如下：

1. 用户登录，提供用户名和密码
2. 服务器验证凭据，生成JWT令牌
3. 客户端存储令牌，后续请求携带令牌
4. 服务器验证令牌有效性，允许访问受保护资源

```javascript
// 生成令牌
const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '24h' });

// 验证令牌
jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) return res.status(403).json({ error: '令牌无效' });
    req.user = user;
    next();
});
```

## 4. 数据交换格式

系统使用JSON作为客户端和服务器之间的数据交换格式。

### 4.1 请求格式

```json
{
  "username": "operator",
  "password": "operator123"
}
```

### 4.2 响应格式

```json
{
  "status": "success",
  "message": "操作成功",
  "data": {
    // 返回的具体数据
  }
}
```

## 5. 开发环境设置

### 5.1 客户端开发环境

1. 安装Qt 5.15.2和Qt Creator
2. 安装OpenCV 4.6.0及其依赖库
3. 配置项目包含路径和库文件路径
4. 配置编译器和调试工具

### 5.2 服务器开发环境

1. 安装Node.js（v14或更高版本）
2. 安装依赖包：
   ```bash
   npm install express cors jsonwebtoken body-parser
   ```
3. 启动服务器：
   ```bash
   node server.js
   ```

## 6. 测试方法

### 6.1 单元测试

使用QtTest框架进行客户端单元测试，测试范围包括：
- NetworkManager类
- 人脸识别算法
- 数据处理功能

### 6.2 集成测试

使用模拟服务器响应测试客户端与服务器的交互：
- 登录认证流程
- 数据获取和提交
- 错误处理机制

### 6.3 手动测试

人脸识别功能需要进行手动测试：
- 在不同光照条件下测试
- 使用不同人脸角度测试
- 测试识别阈值和准确率

## 7. 已知问题和未来改进

### 7.1 已知问题

- 人脸识别在弱光环境下准确率较低
- 服务器数据未持久化存储
- 缺少用户权限细粒度控制

### 7.2 计划改进

- 添加数据库持久化存储
- 优化人脸识别算法，提高准确率
- 实现完整的用户权限管理
- 添加更多数据分析功能 