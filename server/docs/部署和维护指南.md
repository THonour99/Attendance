# 人脸识别排座系统 - 部署和维护指南

## 目录

1. [系统需求](#系统需求)
2. [部署步骤](#部署步骤)
   - [服务器部署](#服务器部署)
   - [客户端部署](#客户端部署)
3. [系统配置](#系统配置)
4. [备份与恢复](#备份与恢复)
5. [日常维护](#日常维护)
6. [故障排除](#故障排除)
7. [系统更新](#系统更新)
8. [安全维护](#安全维护)
9. [性能优化](#性能优化)
10. [联系与支持](#联系与支持)

## 系统需求

### 服务器需求

- **操作系统**: Windows 10/11 或 Linux (Ubuntu 20.04+)
- **处理器**: 至少4核CPU
- **内存**: 最小4GB RAM，推荐8GB+
- **存储空间**: 至少20GB可用空间
- **网络**: 稳定的网络连接，建议100Mbps以上带宽
- **软件依赖**:
  - Node.js v16.0+
  - npm v8.0+
  - MongoDB v5.0+（可选，用于长期数据存储）

### 客户端需求

- **操作系统**: Windows 10/11
- **处理器**: 英特尔酷睿i3第8代或同等级别及以上
- **内存**: 最小4GB RAM，推荐8GB+
- **存储空间**: 至少500MB可用空间
- **摄像头**: 720p或以上分辨率（推荐1080p）
- **网络**: 局域网连接到服务器

## 部署步骤

### 服务器部署

1. **准备环境**

   ```bash
   # 安装Node.js和npm（Windows）
   # 下载并运行Node.js安装程序：https://nodejs.org/

   # 安装Node.js和npm（Linux）
   sudo apt update
   sudo apt install -y nodejs npm
   ```

2. **获取服务器代码**

   ```bash
   # 克隆或下载项目代码
   git clone https://your-repository-url/face-recognition-server.git
   cd face-recognition-server
   ```

3. **安装依赖**

   ```bash
   npm install
   ```

4. **配置服务器**

   创建`.env`文件并设置以下环境变量：

   ```
   PORT=8080
   JWT_SECRET=your_secure_jwt_secret_key
   NODE_ENV=production
   ```

5. **启动服务器**

   ```bash
   # 开发环境
   npm run dev

   # 生产环境
   npm start
   ```

6. **设置为系统服务（可选）**

   - **Windows**: 使用NSSM（Non-Sucking Service Manager）
   - **Linux**: 使用Systemd创建服务

   **Linux示例**:
   ```bash
   sudo nano /etc/systemd/system/face-attendance.service
   ```

   文件内容：
   ```
   [Unit]
   Description=Face Recognition Attendance Server
   After=network.target

   [Service]
   Type=simple
   User=username
   WorkingDirectory=/path/to/face-recognition-server
   ExecStart=/usr/bin/npm start
   Restart=on-failure

   [Install]
   WantedBy=multi-user.target
   ```

   启用并启动服务：
   ```bash
   sudo systemctl enable face-attendance.service
   sudo systemctl start face-attendance.service
   ```

### 客户端部署

1. **准备安装包**
  
   构建可执行文件：
   ```
   # 在Qt项目目录下
   qmake
   make release
   ```

2. **安装环境依赖**

   - 安装Microsoft Visual C++ Redistributable
   - 安装OpenCV运行时依赖（如有需要）

3. **创建桌面快捷方式**

   - 自动安装程序会创建快捷方式
   - 手动安装时，右键可执行文件创建快捷方式

4. **配置客户端**

   创建`config.ini`文件：
   ```ini
   [Network]
   ServerUrl=http://localhost:8080
   
   [Camera]
   DeviceIndex=0
   Resolution=1280x720
   
   [Facial]
   MinFaceSize=80
   DetectionInterval=500
   ```

5. **分发方式**

   - 创建Windows安装程序（推荐）
   - 使用USB驱动器复制程序文件

## 系统配置

### 服务器配置

#### 关键配置文件

- `config.js`: 主要配置文件
- `.env`: 环境变量文件

关键配置项：
```javascript
// config.js 示例
module.exports = {
  port: process.env.PORT || 8080,
  jwtSecret: process.env.JWT_SECRET || 'default_dev_secret',
  jwtExpiration: '24h',
  logLevel: process.env.LOG_LEVEL || 'info',
  dataStorage: {
    type: 'json',  // 或 'mongodb'
    path: './data'
  }
};
```

### 客户端配置

#### 关键配置文件

- `config.ini`: 主配置文件

关键配置项：
```ini
[Network]
ServerUrl=http://server-ip:8080
Timeout=30000

[Application]
LogLevel=INFO
DataPath=./data
AutoStart=true

[FaceRecognition]
MinFaceSize=80
DetectionConfidence=0.7
RecognitionThreshold=0.68
```

## 备份与恢复

### 数据备份

#### 服务器备份

1. **数据备份**

   ```bash
   # 备份JSON数据文件
   tar -czvf server-data-backup-$(date +%Y%m%d).tar.gz ./data/
   
   # MongoDB备份（如使用）
   mongodump --out backup/$(date +%Y%m%d)
   ```

2. **配置备份**

   ```bash
   cp .env .env.backup
   cp config.js config.js.backup
   ```

#### 客户端备份

1. **人脸数据备份**

   ```bash
   # 备份人脸数据目录
   xcopy /E /I C:\Users\Public\Documents\FaceAttendance\faces faces-backup
   ```

2. **配置备份**

   ```bash
   copy config.ini config.ini.backup
   ```

### 数据恢复

#### 服务器恢复

```bash
# 恢复JSON数据
tar -xzvf server-data-backup-20231225.tar.gz -C ./

# MongoDB恢复（如使用）
mongorestore backup/20231225
```

#### 客户端恢复

```bash
# 恢复人脸数据
xcopy /E /I faces-backup C:\Users\Public\Documents\FaceAttendance\faces
```

## 日常维护

### 定期维护任务

| 维护任务 | 频率 | 说明 |
|---------|------|------|
| 数据备份 | 每周 | 备份所有系统数据 |
| 日志检查 | 每日 | 检查系统日志中的错误和警告 |
| 清理临时文件 | 每月 | 删除临时文件和过期日志 |
| 系统更新 | 每季度 | 更新系统组件和依赖库 |
| 性能检查 | 每月 | 检查系统性能指标 |

### 日志管理

服务器日志位置：
- 开发环境：`console`输出和`./logs/`目录
- 生产环境：`./logs/`目录和系统日志

客户端日志位置：
- Windows: `C:\Users\[用户名]\AppData\Local\FaceAttendance\logs\`

## 故障排除

### 常见问题和解决方案

#### 服务器问题

1. **服务器无法启动**
   - 检查Node.js版本兼容性
   - 验证端口是否被占用：`netstat -ano | findstr 8080`
   - 检查日志文件中的具体错误

2. **数据库连接失败**
   - 确认数据库服务运行状态
   - 检查连接凭据和网络连接
   - 验证防火墙规则

3. **API响应缓慢**
   - 检查服务器负载
   - 监控内存使用情况
   - 检查网络连接质量

#### 客户端问题

1. **无法连接到服务器**
   - 验证服务器地址和端口配置
   - 检查网络连接状态
   - 确认防火墙未阻止连接

2. **人脸识别失败**
   - 检查摄像头工作状态
   - 调整光线条件
   - 更新人脸数据库
   - 调整识别阈值

3. **客户端崩溃**
   - 检查错误日志
   - 验证系统资源占用
   - 重新安装客户端

### 诊断工具

1. **服务器诊断**
   - 运行内置诊断工具：`npm run diagnose`
   - 检查系统日志：`tail -f logs/error.log`

2. **客户端诊断**
   - 启用详细日志：修改`config.ini`中的`LogLevel=DEBUG`
   - 运行系统诊断：启动时使用`--diagnose`参数

## 系统更新

### 服务器更新

1. **备份当前系统**
   ```bash
   # 备份数据和配置
   bash backup.sh
   ```

2. **获取更新**
   ```bash
   git pull origin main
   ```

3. **安装新依赖**
   ```bash
   npm install
   ```

4. **应用数据库迁移（如需）**
   ```bash
   npm run migrate
   ```

5. **重启服务**
   ```bash
   sudo systemctl restart face-attendance
   ```

### 客户端更新

1. **下载新版安装包**
2. **关闭所有客户端实例**
3. **运行安装程序**
4. **验证更新后版本**

## 安全维护

### 安全最佳实践

1. **定期更新密钥**
   - JWT密钥应至少每季度更换一次
   - 保存密钥的安全备份

2. **权限管理**
   - 定期审查用户权限
   - 移除不再需要的账户
   - 使用最小权限原则

3. **安全配置**
   - 禁用不必要的功能和端口
   - 启用HTTPS
   - 配置适当的CORS策略

4. **安全审计**
   - 定期检查系统日志查找异常行为
   - 监控登录尝试
   - 审计数据访问模式

### 漏洞管理

1. **依赖检查**
   ```bash
   npm audit
   ```

2. **安全补丁应用**
   ```bash
   npm audit fix
   ```

3. **安全通告订阅**
   - 订阅Node.js安全通告
   - 监控OpenCV安全更新

## 性能优化

### 服务器优化

1. **Node.js性能调优**
   ```bash
   # 使用生产模式
   NODE_ENV=production npm start
   
   # 使用PM2进行进程管理
   pm2 start server.js -i max
   ```

2. **数据库优化**
   - 创建合适的索引
   - 定期数据压缩
   - 监控查询性能

### 客户端优化

1. **降低分辨率**
   - 对于性能较低的设备，可降低摄像头分辨率
   
2. **调整检测频率**
   - 增加人脸检测间隔时间可减少CPU使用率

3. **加速启动**
   - 预加载人脸数据
   - 优化初始化过程

## 联系与支持

### 技术支持

- **电子邮件**: support@face-attendance.com
- **支持热线**: 400-888-8888
- **在线支持**: https://support.face-attendance.com

### 报告问题

报告问题时请提供以下信息：
1. 系统版本号
2. 错误日志
3. 问题重现步骤
4. 系统环境信息

### 更新渠道

- **官方网站**: https://www.face-attendance.com/updates
- **邮件通知**: 订阅更新邮件列表
- **内部更新**: 客户端自动检查更新 